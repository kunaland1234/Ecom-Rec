name: Deploy Recommender to ECS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # -----------------------------
    # Build & Push Docker Image
    # -----------------------------
    - name: Build, tag, and push image
      run: |
        IMAGE_TAG=${GITHUB_SHA::7}
        IMAGE_URI=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:${IMAGE_TAG}

        echo "Building image: ${IMAGE_URI}"
        docker build --no-cache -t ${IMAGE_URI} .
        docker push ${IMAGE_URI}

        echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

    # -----------------------------
    # Fetch existing task definition
    # -----------------------------
    - name: Get current task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition ${{ secrets.TASK_FAMILY }} \
          --query taskDefinition \
          > task-def.json

    # -----------------------------
    # Create new task definition revision
    # -----------------------------
    - name: Register new task definition revision
      run: |
        cat task-def.json \
          | jq --arg IMAGE "$IMAGE_URI" '
            del(
              .taskDefinitionArn,
              .revision,
              .status,
              .requiresAttributes,
              .compatibilities,
              .registeredAt,
              .registeredBy
            )
            | .containerDefinitions[0].image = $IMAGE
          ' > new-task-def.json

        echo "Registering new task definition with image: $IMAGE_URI"
        
        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-def.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        
        echo "New task definition: ${NEW_TASK_DEF_ARN}"
        echo "NEW_TASK_DEF_ARN=${NEW_TASK_DEF_ARN}" >> $GITHUB_ENV

    # -----------------------------
    # Update ECS Service
    # -----------------------------
    - name: Update ECS service
      run: |
        echo "Updating ECS service with task definition: ${NEW_TASK_DEF_ARN}"
        
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service ${{ secrets.ECS_SERVICE }} \
          --task-definition ${NEW_TASK_DEF_ARN} \
          --force-new-deployment

    # -----------------------------
    # Wait for deployment to complete
    # -----------------------------
    - name: Wait for service stability
      run: |
        echo "Waiting for service to stabilize..."
        aws ecs wait services-stable \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }}
        
        echo "Deployment completed successfully!"

    # -----------------------------
    # Verify running image
    # -----------------------------
    - name: Verify deployment
      run: |
        echo "Verifying running tasks..."
        RUNNING_IMAGE=$(aws ecs describe-services \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --services ${{ secrets.ECS_SERVICE }} \
          --query 'services[0].taskDefinition' \
          --output text | xargs -I {} aws ecs describe-task-definition \
          --task-definition {} \
          --query 'taskDefinition.containerDefinitions[0].image' \
          --output text)
        
        echo "Currently running image: ${RUNNING_IMAGE}"
        echo "Expected image: ${IMAGE_URI}"