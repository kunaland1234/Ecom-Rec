name: Deploy Recommender to ECS

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  ECS_SERVICE: ${{ secrets.ECS_SERVICE }}
  TASK_FAMILY: ${{ secrets.TASK_FAMILY }}
  CONTAINER_NAME: recommender

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # -----------------------------
    # Build & Push Docker Image
    # -----------------------------
    - name: Build, tag, and push image
      run: |
        IMAGE_TAG=${GITHUB_SHA::7}
        IMAGE_URI=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}

        docker build --no-cache -t ${IMAGE_URI} .
        docker push ${IMAGE_URI}

        echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

    # -----------------------------
    # Fetch existing task definition
    # -----------------------------
    - name: Get current task definition
      run: |
        aws ecs describe-task-definition \
          --task-definition ${TASK_FAMILY} \
          --query taskDefinition \
          > task-def.json

    # -----------------------------
    # Create new task definition revision
    # -----------------------------
    - name: Register new task definition revision
      run: |
        cat task-def.json \
          | jq --arg IMAGE "$IMAGE_URI" '
            del(
              .taskDefinitionArn,
              .revision,
              .status,
              .requiresAttributes,
              .compatibilities,
              .registeredAt,
              .registeredBy
            )
            | .containerDefinitions[0].image = $IMAGE
          ' > new-task-def.json

        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://new-task-def.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        
        echo "NEW_TASK_DEF_ARN=${NEW_TASK_DEF_ARN}" >> $GITHUB_ENV

    # -----------------------------
    # Update ECS Service
    # -----------------------------
    - name: Update ECS service
      run: |
        aws ecs update-service \
          --cluster ${ECS_CLUSTER} \
          --service ${ECS_SERVICE} \
          --task-definition ${NEW_TASK_DEF_ARN} \
          --force-new-deployment